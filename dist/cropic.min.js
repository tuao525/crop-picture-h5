!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t=t||self).Cropic=i()}(this,function(){"use strict";var t,i,e,o;t=".cropic-body{top:0;left:0;-webkit-transform:translateY(100%);-ms-transform:translateY(100%);transform:translateY(100%);-webkit-transition:.4s;-o-transition:.4s;transition:.4s;-webkit-touch-callout:none;-webkit-user-select:none;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:99;overflow:hidden}.cropic-body,.shady-plot{background:#1c1c1c;position:fixed;width:100%;height:100%}.shady-plot{z-index:999}.cropic-body *{-webkit-box-sizing:border-box;box-sizing:border-box}.cropic-operation-bar{display:-webkit-box;display:-ms-flexbox;display:flex;color:#f2f2f2;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;position:absolute;width:100%;bottom:0;left:0}.cropic-operation-bar [role=button]{padding:30px 20px;font-size:1em}.cropic-frame{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);transition:.3s;border:2px solid #fff}.cropic-frame img{-webkit-touch-callout:none;pointer-events:none}.cropic-frame-show{overflow:hidden}.cropic-frame-show-border{display:none}.cropic-frame-show-border1{left:33.33%}.cropic-frame-show-border1,.cropic-frame-show-border2{position:absolute;width:.5px;height:100%;top:0;background-color:#fff}.cropic-frame-show-border2{left:66.66%}.cropic-frame-show-border3{top:33.33%}.cropic-frame-show-border3,.cropic-frame-show-border4{position:absolute;width:100%;height:.5px;left:0;background-color:#fff}.cropic-frame-show-border4{top:66.66%}.cropic-cancel{color:#e04c4c}.cropic-reset{color:#3680fd}.cropic-confirm{color:#23c667}.cropic-layer,.cropicFadeOut{position:fixed;width:100%;height:100%;top:0;left:0;background:rgba(0,0,0,.8);pointer-events:none;transform:translateZ(0)}.cropicFadeOut{display:block;animation:cropicFadeOut .5s ease-in-out forwards}.border-line{opacity:0}.borderLinefadeIn{opacity:1}.borderLinefadeOut{animation:borderLinefadeOut .5s ease-in-out forwards}@keyframes cropicFadeOut{0%{opacity:0}to{opacity:1}}@keyframes borderLinefadeOut{0%{opacity:1}to{opacity:0}}",i=(i=void 0===i?{}:i).insertAt,t&&"undefined"!=typeof document&&(e=document.head||document.getElementsByTagName("head")[0],(o=document.createElement("style")).type="text/css","top"===i&&e.firstChild?e.insertBefore(o,e.firstChild):e.appendChild(o),o.styleSheet?o.styleSheet.cssText=t:o.appendChild(document.createTextNode(t)));function s(t,i){for(var e=0;e<i.length;e++){var o=i[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(){if(!(this instanceof n))throw new TypeError("Cannot call a class as a function");this.default={width:500,height:500,src:"",ratio:1,encode:"base64",type:"jpeg",name:"crop-picture",quality:.9,buttonText:["取消","重置","完成"],buttonColor:["#e04c4c","#3680fd","#23c667"],buttonSize:12},this.init(),this.cropic=this.getId("cropic"),this.img1=this.getId("cropicImg1"),this.img2=this.getId("cropicImg2"),this.frame1=this.getId("cropicFrame1"),this.frame2=this.getId("cropicFrame2"),this.cancelBtn=this.getId("cropicCancel"),this.resetBtn=this.getId("cropicReset"),this.confirmBtn=this.getId("cropicConfirm"),this.borderLine=this.getId("borderLine"),this.cropicLayer=this.getId("cropicLayer"),this.shadyPlot=this.getId("shadyPlot"),this.reset=this.reset.bind(this),this.done=this.done.bind(this),this.cancel=this.cancel.bind(this)}return function(t,i,e){return i&&s(t.prototype,i),e&&s(t,e),t}(n,[{key:"init",value:function(){this.getId("cropic")||this.createHtml()}},{key:"getId",value:function(t){return document.getElementById(t)}},{key:"createHtml",value:function(){var t=document.createElement("div");t.className="cropic-body",t.setAttribute("id","cropic"),t.innerHTML='\n  <div class=\'shady-plot\' id=\'shadyPlot\'></div>\n    <div class="cropic-frame" id="cropicFrame1"><img id="cropicImg1"></div>\n    <div class="cropic-layer" id="cropicLayer"></div>\n    <div class="cropic-frame cropic-frame-show" id="cropicFrame2">\n      <img id="cropicImg2">\n      <div id="borderLine" class="border-line">\n        <div class="cropic-frame-show-border1"></div>\n        <div class="cropic-frame-show-border2"></div>\n        <div class="cropic-frame-show-border3"></div>\n        <div class="cropic-frame-show-border4"></div>\n      </div>\n    </div>\n    <div class="cropic-operation-bar">\n      <div class="cropic-cancel" id="cropicCancel" role="button">取消</div>\n      <div class="cropic-reset" id="cropicReset" role="button">重置</div>\n      <div class="cropic-confirm" id="cropicConfirm" role="button">完成</div>\n    </div>\n  ',document.body.appendChild(t)}},{key:"getImage",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},i=(this.scale=1,this.rotate=0,this.translateX=0,this.translateY=0,this.cropicWidth=0,this.cropicHeight=0,JSON.parse(JSON.stringify(this.default))),i=(this.options=Object.assign(i,t),this.cancelBtn.innerHTML=this.options.buttonText[0],this.resetBtn.innerHTML=this.options.buttonText[1],this.confirmBtn.innerHTML=this.options.buttonText[2],this.cancelBtn.style.color=this.options.buttonColor[0],this.resetBtn.style.color=this.options.buttonColor[1],this.confirmBtn.style.color=this.options.buttonColor[2],this.cancelBtn.style.fontSize=this.options.buttonSize+"px",this.resetBtn.style.fontSize=this.options.buttonSize+"px",this.confirmBtn.style.fontSize=this.options.buttonSize+"px",this.img1.src=this.options.src,this.img2.src=this.options.src,new Image);i.onload=function(){e.originW=e.img2.width,e.originH=e.img2.height,e.originRatio=e.originW/e.originH,e.initSize(),e.cropic.style.transform="translate(0, 0)",setTimeout(function(){var t=0,i=0;e.img1.width>e.img1.height?(e.img1.style.height=e.frame1.clientHeight+"px",e.img2.style.height=e.frame1.clientHeight+"px",e.img1.style.width=e.img1.width*(e.frame1.clientHeight/e.img1.height)+"px",e.img2.style.width=e.img1.width*(e.frame1.clientHeight/e.img1.height)+"px"):(e.img1.style.width=e.frame1.clientWidth+"px",e.img2.style.width=e.frame1.clientWidth+"px",e.img1.style.height=e.img1.height*(e.frame1.clientWidth/e.img1.width)+"px",e.img2.style.height=e.img1.height*(e.frame1.clientWidth/e.img1.width)+"px"),i=e.img1.height>e.img1.width?(e.translateY=-Math.floor((e.img1.height-e.options.cropicHeight)/2),t=e.translateX=0,-Math.floor((e.img1.height-e.options.cropicHeight)/2)):(e.translateX=-Math.floor((e.img1.width-e.options.cropicWidth)/2),e.translateY=0,t=-Math.floor((e.img1.width-e.options.cropicWidth)/2),0),e.setTransform(t,i)},300),setTimeout(function(){e.shadyPlot.style.display="none"},310),e.cancelBtn.addEventListener("click",e.cancel),e.resetBtn.addEventListener("click",e.reset),e.confirmBtn.addEventListener("click",e.done),e.cropic.addEventListener("touchmove",function(t){t.preventDefault(),1<t.touches.length?(e.setScale(t.touches[0],t.touches[1]),e.setRotate(t.touches[0],t.touches[1])):(e.setTranslate(t.touches[0]),e.cropicLayer.style.display="none",e.borderLine.setAttribute("class","borderLinefadeIn"),e.cropicLayer.setAttribute("class","cropic-layer"))}),e.cropic.addEventListener("touchend",function(t){e.distance=null,e.angle=null,e.moveX=null,e.moveY=null,setTimeout(function(){e.cropicLayer.style.display="block",e.borderLine.setAttribute("class","borderLinefadeOut"),e.cropicLayer.setAttribute("class","cropicFadeOut")},300)})},i.src=this.options.src}},{key:"initSize",value:function(){var t=document.documentElement||document.body,i=0,e=0,o=this.options.width/this.options.height,e=1==o?t.clientHeight>t.clientWidth?(i=t.clientWidth-60,t.clientWidth-60):(i=t.clientHeight-60,t.clientHeight-60):t.clientHeight>t.clientWidth?t.clientWidth>this.options.width?(i=this.options.width,this.options.height):(i=t.clientWidth-60,(t.clientWidth-60)/o):t.clientHeight>this.options.height?(i=this.options.width,this.options.height):(i=t.clientHeight-60,(t.clientHeight-60)/o);this.options.cropicWidth=i,this.options.cropicHeight=e,this.options.width=i,this.options.height=e,this.frame1.style.width=i+"px",this.frame1.style.height=e+"px",this.frame2.style.width=i+"px",this.frame2.style.height=e+"px",this.cropicLayer.style.display="block"}},{key:"setScale",value:function(t,i){var e=Math.abs(t.clientX-i.clientX),t=Math.abs(t.clientY-i.clientY),i=Math.sqrt(e*e+t*t);this.distance&&(this.scale+=(i-this.distance)/this.img2.clientWidth,this.setTransform()),this.distance=i}},{key:"setRotate",value:function(t,i){var e=t.clientX-i.clientX,t=t.clientY-i.clientY,i=180*Math.atan2(t,e)/Math.PI;this.angle&&(this.rotate+=i-this.angle,this.setTransform()),this.angle=i}},{key:"setTranslate",value:function(t){var i=t.clientX,t=t.clientY;this.moveX&&(this.translateX+=i-this.moveX),this.moveY&&(this.translateY+=t-this.moveY),this.moveX=i,this.moveY=t,this.setTransform()}},{key:"setTransform",value:function(t,i){var e="";console.log("x",t,i),e=t||i?"translate("+t+"px, "+i+"px) scale("+this.scale+") rotate("+this.rotate+"deg)":"translate("+this.translateX+"px, "+this.translateY+"px) scale("+this.scale+") rotate("+this.rotate+"deg)",this.img1.style.transform=e,this.img2.style.transform=e}},{key:"cancel",value:function(t){var i=this;this.cropic.style.transform="translate(0, 100%)",setTimeout(function(){i.img1.style="",i.img1.src="",i.img2.style="",i.img2.src=""},400),this.options.onCancel&&"done"!==t&&this.options.onCancel(),this.cancelBtn.removeEventListener("click",this.cancel),this.resetBtn.removeEventListener("click",this.reset),this.confirmBtn.removeEventListener("click",this.done,!0),this.shadyPlot.style.display="block"}},{key:"reset",value:function(){var t=this;this.scale=1,this.rotate=0,this.img1.height>this.img1.width?(this.translateY=-Math.floor((this.img1.height-this.options.cropicHeight)/2),this.translateX=0):(this.translateX=-Math.floor((this.img1.width-this.options.cropicWidth)/2),this.translateY=0),this.img1.style.transition="0.3s",this.img2.style.transition="0.3s",this.setTransform(),setTimeout(function(){t.img1.style.transition="",t.img2.style.transition=""},300)}},{key:"done",value:function(){var i=this,t=this.options.width/this.frame2.clientWidth,e=document.createElement("canvas"),o=(e.width=this.options.width,e.height=this.options.height,e.getContext("2d")),s=(o.fillStyle="#000",o.fillRect(0,0,e.width,e.height),void 0),n=void 0,r=(this.img1.height>this.img1.width?(s=this.options.width,n=this.img1.height/(this.img1.width/this.options.width)):(n=this.options.height,s=this.img1.width/(this.img1.height/this.options.height)),{x:s/2,y:n/2});if(o.translate(this.translateX*t,this.translateY*t),0!==this.rotate&&(o.translate(r.x,r.y),o.rotate(this.rotate*Math.PI/180),o.translate(-r.x,-r.y)),1!==this.scale&&(o.translate(r.x*(1-this.scale),r.y*(1-this.scale)),o.scale(this.scale,this.scale)),o.drawImage(this.img2,0,0,s,n),this.options.onDone)switch(this.options.encode){case"base64":this.options.onDone(e.toDataURL("image/"+this.options.type,this.options.quality));break;case"blob":e.toBlob(function(t){i.options.onDone(t)},"image/"+this.options.type);break;case"file":e.toBlob(function(t){t=new window.File([t],i.options.name,{type:"image/"+i.options.type});i.options.onDone(t)},"image/"+this.options.type);break;default:this.options.onDone(e.toDataURL("image/"+this.options.type,this.options.quality))}this.cancel("done")}}]),n});
